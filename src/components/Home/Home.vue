<template>
  <div>
    <NavBar
      :inAnalysis="inAnalysis"
      :viewOptions="viewOptions"
      @goHome="goHome"
      @goExamples="goExamples"
      @updateSettings="updateSettings"
      @updateViewOptions="updateViewOptions"
    ></NavBar>
    <div class="content">
      <template v-if="displayExamples">
        <Examples @finish="finish"></Examples>
      </template>
      <template v-else>
        <UploadWorkflow
          v-if="uploadedFile && updateSettingsVisible"
          :passedUploadedFile="uploadedFile"
          @finish="finish"
          @closeModal="closeUpdateSettings"
        ></UploadWorkflow>
        <div :style="`background: url(${require('@/assets/background.svg')}) center; height: 100%;`">
          <TableAndMap
            v-if="uploadedFile"
            :viewOptions="viewOptions"
            :uploadedFile="uploadedFile"
            :filters="filters"
            :sorting="sorting"
            :map="map"
            :tableLogic="tableLogic"
            @updateOverlayEventJsons="updateOverlayEventJsons"
            @rowSelectionsChanged="rowSelectionsChanged"
            @sortChanged="sortChanged"
            @filterChanged="filterChanged"
          ></TableAndMap>
          <div v-else class="begin">
            <CallToAction @finish="finish"></CallToAction>
          </div>
        </div>
      </template>
    </div>
  </div>
</template>
<script lang='ts'>
import { Component, Prop, Vue } from "vue-property-decorator";
import TableAndMap from "@/components/TableAndMap/TableAndMap.vue";
import CallToAction from "./CallToAction/CallToAction.vue";
import UploadWorkflow from "@/components/UploadWorkflow/UploadWorkflow.vue";
import UploadedFile from "@/entities/UploadedFile";
import TableLogic from "@/components/TableAndMap/Table/TableLogic";
import { OverlayJson } from "../TableAndMap/GoogleMap/Utils";
import { TableAndMapMap } from "../TableAndMap/Types";
import NavBar from "@/components/NavBar/NavBar.vue";
import Examples from "@/components/Examples/Examples.vue";

/**
 * Contain content about what TableAndMap what it does
 */
@Component({
  components: {
    NavBar,
    UploadWorkflow,
    CallToAction,
    TableAndMap,
    Examples
  }
})
export default class Home extends Vue {
  private uploadedFile: UploadedFile | null = null;
  private filters: { [colId: string]: any } = {};
  private sorting: { colId: string; sort: string }[] = [];
  private map: TableAndMapMap = {
    overlayEventJsons: [],
    infoWindowKeys: [],
    allowDraw: true
  };
  private tableLogic: TableLogic | null = null;
  private viewOptions: string[] = ["map", "table"];
  private updateSettingsVisible: boolean = false;
  private displayExamples: boolean = false;

  private get inAnalysis(): boolean {
    return this.uploadedFile !== null;
  }

  private finish(uploadedFile: UploadedFile) {
    this.uploadedFile = uploadedFile;
    this.filterChanged({});
    this.sortChanged([]);
    this.map = {
      overlayEventJsons: [],
      infoWindowKeys: [],
      allowDraw: true
    };
    this.tableLogic = new TableLogic(uploadedFile);
    this.updateSettingsVisible = false;
    this.displayExamples = false;
  }

  private goHome(): void {
    this.uploadedFile = null;
    this.filterChanged({});
    this.sortChanged([]);
    this.map = {
      overlayEventJsons: [],
      infoWindowKeys: [],
      allowDraw: true
    };
    this.tableLogic = null;
    this.displayExamples = false;
  }

  private goExamples(): void {
    this.displayExamples = true;
  }

  private updateOverlayEventJsons(overlayEventJsons: OverlayJson[]) {
    this.map.overlayEventJsons = overlayEventJsons;
  }

  private rowSelectionsChanged(rowIds: string[]) {
    if (this.uploadedFile) {
      const rowIdsSet = new Set(rowIds);
      this.uploadedFile.data.forEach(row => {
        row.isSelected = rowIdsSet.has(row.id);
      });
    }
  }

  private sortChanged(sorting: { colId: string; sort: string }[]) {
    this.sorting = sorting;
  }

  private filterChanged(filters: { [colId: string]: any }) {
    this.filters = filters;
  }

  private updateSettings() {
    this.updateSettingsVisible = true;
  }

  private closeUpdateSettings() {
    this.updateSettingsVisible = false;
  }

  private updateViewOptions(viewOptions: string[]) {
    this.viewOptions = viewOptions;
  }
}
</script>
<style lang='scss' scoped>
.content {
  margin-top: 52px;
  height: 100%;
  .begin {
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }
}
</style>